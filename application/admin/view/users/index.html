{extend name="index/index"}

{block name="main"}
<!-- page heading start-->
<div class="page-heading">
    <h3>
        用户管理
    </h3>
    <ul class="breadcrumb">
        <li>
            <a href="{url('admin/index/index')}">首页</a>
        </li>
        <li class="active"> 用户列表</li>
    </ul>
</div>
<!-- page heading end-->

<!--body wrapper start-->
<div class="wrapper">
    <div class="row">
        <div class="col-sm-12">
            <section class="panel">
                <header class="panel-heading">
                    用户列表
                    <!--<button  class=" btn-info btn-sm" data-toggle="modal" data-target="#myModal1">添加图片</button>-->
                    <span class="tools pull-right">
                        <a href="javascript:;" class="fa fa-chevron-down"></a>
                        <a href="javascript:;" class="fa fa-times"></a>
                     </span>
                </header>
                <div class="panel-body">
                    {if condition="empty($p)"}
                    <p style="text-align: center">啊偶~~还没有用户注册%>_<%~~~</p>
                    {else /}
                    <div class="adv-table editable-table ">
                    </div>
                    <div class="space15"></div>
                    <table class="table table-striped table-hover table-bordered" id="editable-sample" style="text-align: center">
                        <thead>
                        <tr >
                            <th style="text-align: center">编号</th>
                            <th style="text-align: center">用户名</th>
                            <th style="text-align: center">性别</th>
                            <th style="text-align: center">手机号</th>
                            <th style="text-align: center">邮箱</th>
                            <th style="text-align: center">订单总量</th>
                            <th style="text-align: center">消费总额</th>
                            <th style="text-align: center">注册时间</th>
                            <th style="text-align: center">评论状态</th>
                            <th style="text-align: center">操作</th>

                        </tr>
                        </thead>
                        <tbody>
                        <!--{volist name="list" id="v" key="k"}-->
                        {volist name='$p->data' id='v' key="k"}
                        <tr>
                            <td align="center" valign="middle">{$k}</td>
                            <td align="center" valign="middle">{$v.u_username}</td>
                            <td align="center" valign="middle">{if condition='($v.ud_sex==1)'}男{else /}女{/if}</td>
                            <td align="center" valign="middle">{$v.u_phone}</td>
                            <td align="center" valign="middle">{$v.ud_email}</td>
                            <td align="center" valign="middle">订单总量</td>
                            <td align="center" valign="middle">消费总额</td>
                            <td align="center" valign="middle">{:date('Y-m-d',$v.u_create_time)}</td>
                            <td align="center" valign="middle" id="ban{$v.u_id}">{if condition='($v.is_comment==0)'}开放{else /}禁言{/if}</td>


                            <td class="col-md-4">
                                <!--<button class=" btn-info btn-sm" data-toggle="modal" data-target="#myModal">查看大图</button>-->
                                <button class=" btn btn-info btn-sm" data-toggle="modal" data-target="#myModal2">查看</button>
                                <button class=" btn btn-warning bin-btn btn-sm" bin-id="{$v.u_id}">禁言</button>
                                <button class=" btn btn-danger del-btn btn-sm" del-id="{$v.u_id}" >删除</button>

                            </td>
                        </tr>
                        {/volist}
                        </tbody>
                    </table>
                    {/if}
                </div>
                <!--{$p->render}-->
                <div style="text-align:center">{$p->render}</div>
                <!--<div style="text-align:center">共{$p->total}条 第{$p->page}页 共{$p->pageNum}页</div>-->
            </section>

        </div>

    </div>
</div>
<!--body wrapper end-->

<div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel2">查看用户资料</h4>
            </div>
            <div class="modal-body">
                <form action="" method="post" enctype="multipart/form-data">
                    <div class="form-group">
                        <label>用户名:</label><br>
                        <input type="text" class="form-control" value="{$v.u_username}" >
                        <label >电话:</label><br>
                        <input type="text" class="form-control" value="{$v.u_phone}" >
                        <label >邮箱:</label><br>
                        <input type="text" class="form-control" value="{$v.ud_email}" >

                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

<!-- main content end-->
{/block}
{block name="myjs"}
<!-- Placed js at the end of the document so the pages load faster -->
<script src="/static/app/admin/js/jquery-1.10.2.min.js"></script>
<script src="/static/app/admin/js/jquery-ui-1.9.2.custom.min.js"></script>
<script src="/static/app/admin/js/jquery-migrate-1.2.1.min.js"></script>
<script src="/static/app/admin/js/bootstrap.min.js"></script>
<script src="/static/app/admin/js/modernizr.min.js"></script>
<script src="/static/app/admin/js/jquery.nicescroll.js"></script>

<!--data table-->
<script type="text/javascript" src="/static/app/admin/js/data-tables/jquery.dataTables.js"></script>
<script type="text/javascript" src="/static/app/admin/js/data-tables/DT_bootstrap.js"></script>

<!--common scripts for all pages-->
<script src="/static/app/admin/js/scripts.js"></script>

<!--script for editable table-->
<script src="/static/app/admin/js/editable-table.js"></script>
<script src="/static/app/admin/js/toastr.min.js"></script>

<!-- END JAVASCRIPTS -->


<script>
    $(function () {
        //触发禁用操作
        $('.bin-btn').click(function () {
            var id = $(this).attr('bin-id');
            //console.log($('#ban').html());
            if ($('#ban'+id).html() == '禁言') {
                alert('此用户已是禁止评论状态');
                return;
            } else if (confirm('确定要限制此用户的评论权限')) {
                //console.log(id);
                updateAjax(id);
            }
        });

        //删除
        $('.del-btn').click(function () {
            var id = $(this).attr('del-id');

            if (confirm('小主,确定要 [ 删除 ] 此用户么,请三思啊?')) {
                var obj = $(this).parents('tr');
                delAjax(id, obj);// 调用执行AJAX删除
            }
        });
    });
    // 设置弹框参数
    toastr.options = {
        closeButton: true,
        progressBar: true,
        timeOut: "1500",
        positionClass: "toast-top-full-width"
    };
    // 执行AJAX
    function updateAjax(id) {
        $.ajax({
            type: 'put',
            url: '/usersmg/' + id,
            dataType: 'json',
            success: function (data) {
                //console.log(data);
                if (data.status) {
                    toastr.success(data.info);
                    $('#ban'+id).html('禁言');
                } else {
                    toastr.error(data.info, 'WARNING:');
                }
            },
            error: function () {
                alert('AJAX操作失败');
            }
        });
    }

    //删除
    function delAjax(id, obj) {
        $.ajax({
            type: 'delete',
            url: '/usersmg/' + id,
            dataType: 'json',
            success: function (data) {
                console.log(data);
                if (data.status) {
                    toastr.success(data.info);
                    // 将当前的节点删除掉
                    obj.remove();
                } else {
                    toastr.error(data.info, 'FBI WARNING:');
                }
            },
            error: function () {
                alert('AJAX操作失败');
            }
        });
    }

    //    // 执行AJAX查询单条数据
    //    function showAjax(id) {
    //        $.ajax({
    //            type: 'get',
    //            url: '/users/' + id,
    //            dataType: 'json',
    //            async: false,
    //            success: function (data) {
    //                console.log(data);
    //                // 遍历模态框
    //                if (data.status) {
    //                    // 标题填充
    //                    $('.modal-title u').html(data.title);
    //                    // 填充内容信息
    //                    var msg = data.datas.id + '/' + data.datas.name + '/' + data.datas.province;
    //                    $('.modal-body h3').html(msg);
    //                } else {
    //                    $('.modal-title u').html(data.title);
    //                    $('.modal-body h3').html(data.datas);
    //                }
    //
    //            },
    //            error: function () {
    //                // AJAX操作失败
    //                alert('AJAX操作失败');
    //            }
    //        });
    //    }
    //




</script>
{/block}